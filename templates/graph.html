<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Git Graph Visualization</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f7f9fc;
    }
    header {
      text-align: center;
      padding: 1rem 0;
      background-color: #fff;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    header h2 {
      margin: 0;
      font-size: 1.8rem;
    }
    header h3 {
      margin: 0.3rem 0 0;
      font-weight: normal;
      color: #555;
    }
    header p {
      margin: 0.5rem 0 0;
      font-size: 0.9rem;
      color: #666;
    }
    svg {
      width: 100%;
      height: calc(100vh - 100px);
      display: block;
      border-top: 1px solid #ccc;
      background-color: #fff;
    }
    .link {
      stroke: #999;
      stroke-opacity: 0.6;
    }
    .node {
      stroke: #fff;
      stroke-width: 1.5px;
      cursor: pointer;
    }
    .tooltip {
      position: absolute;
      background: #fff;
      border: 1px solid #ccc;
      padding: 6px;
      font-size: 13px;
      pointer-events: none;
      border-radius: 4px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
      display: none;
      max-width: 300px;
    }
  </style>
</head>
<body>
  <header>
    <h2>Git Graph Visualization</h2>
    <h3>Repository: {{.Name}}</h3>
    <p>(Drag nodes to reposition. Hover for details.)</p>
  </header>

  <svg></svg>
  <div id="tooltip" class="tooltip"></div>

  <script>
    const repoID = "{{.RepoID}}";
    const svg = d3.select("svg");
    const width = window.innerWidth;
    const height = window.innerHeight - 100;
    const tooltip = d3.select("#tooltip");

    // Define arrow marker
    svg.append("defs").append("marker")
      .attr("id", "arrowhead")
      .attr("viewBox", "0 -5 10 10")
      .attr("refX", 28)
      .attr("refY", 0)
      .attr("markerWidth", 8)
      .attr("markerHeight", 8)
      .attr("orient", "auto")
      .append("path")
      .attr("d", "M0,-5L10,0L0,5")
      .attr("fill", "#999");

    fetch(`/graph/${repoID}/json`)
      .then(res => res.json())
      .then(graph => {
        const simulation = d3.forceSimulation(graph.nodes)
          .force("link", d3.forceLink(graph.links).id(d => d.id).distance(120))
          .force("charge", d3.forceManyBody().strength(-300))
          .force("center", d3.forceCenter(width/2, height/2));

        const link = svg.append("g")
          .selectAll("line")
          .data(graph.links)
          .enter().append("line")
          .attr("class", "link")
          .attr("marker-end", "url(#arrowhead)");

        const node = svg.append("g")
          .selectAll("circle")
          .data(graph.nodes)
          .enter().append("circle")
          .attr("class", "node")
          .attr("r", 12)
          .attr("fill", d => {
            if(d.type==="commit") return "steelblue";
            if(d.type==="tree") return "green";
            if(d.type==="blob") return "orange";
            return "gray";
          })
          .on("mouseover", (event, d) => {
            let html = `<strong>${d.type.toUpperCase()}</strong><br>`;
            html += `SHA: ${d.id.substring(0, 7)}<br>`;
            if(d.type==="commit") {
              html += `Msg: ${d.label || ""}<br>`;
              html += `By: ${d.extra.author || ""}<br>`;
              html += `Date: ${d.extra.date || ""}<br>`;
            }
            if(d.type==="blob") {
              html += `File: ${d.extra.filename || ""}<br>`;
            }
            if(d.type==="tree") {
              html += `Dir: ${d.label}<br>`;
            }
            tooltip.style("display","block")
              .style("left",(event.pageX+10)+"px")
              .style("top",(event.pageY+10)+"px")
              .html(html);
          })
          .on("mouseout", () => tooltip.style("display","none"))
          .call(drag(simulation));

        simulation.on("tick", () => {
          link
            .attr("x1", d=>d.source.x)
            .attr("y1", d=>d.source.y)
            .attr("x2", d=>d.target.x)
            .attr("y2", d=>d.target.y);

          node
            .attr("cx", d=>d.x)
            .attr("cy", d=>d.y);
        });

        function drag(sim) {
          function dragstarted(event,d){if(!event.active) sim.alphaTarget(0.3).restart(); d.fx=d.x; d.fy=d.y;}
          function dragged(event,d){d.fx=event.x; d.fy=event.y;}
          function dragended(event,d){if(!event.active) sim.alphaTarget(0); d.fx=null; d.fy=null;}
          return d3.drag().on("start",dragstarted).on("drag",dragged).on("end",dragended);
        }
      });
  </script>
</body>
</html>
